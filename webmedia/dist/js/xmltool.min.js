"undefined"==typeof xmltool&&(xmltool={}),xmltool.jstree={},function(a,b){"use strict";var c="tree_",d="collapse_";this.getFormId=function(a){return a.a_attr.id.slice(c.length)},this.getFormElement=function(a){var c=this.getFormId(a);return b.utils.getElementById(c)},this.getCollapsibleElement=function(c){var d=this.getFormId(c);return a("#"+b.utils.escapeAttr(d)+" > .panel-collapse")},this.getTreeElementFromId=function(a){var d=c+a;return b.utils.getElementById(d)},this.getTreeElementFromTextarea=function(a){var d=c+a.parent().attr("id");return b.utils.getElementById(d)},this.getTreeElementFromCollapsible=function(a){var e=c+a.attr("id").slice(d.length);return b.utils.getElementById(e)},this.getFirstClass=function(a){return a.li_attr["class"].split(" ")[0]},this.getFormPrefix=function(a){return this.getFirstClass(a).slice(c.length)},this.findParentNodeAndPosition=function(b){for(var c=0;c<b.length;c++){var d=b[c][0],e=a(b[c][1]);if(e.length>1)return{};if(e.length)return{parentobj:e,position:d}}return{}},this.getNodePositionInChildren=function(a,b){for(var c=0,d=b.length;d>c;c++)if(b[c].id===a.id)return c;return-1},this.getNodeSiblingsAndSelf=function(b){for(var c=a("#tree").jstree("get_node",b.parent),d=this.getFirstClass(b),e=[],f=0,g=c.children.length;g>f;f++){var h=a("#tree").jstree("get_node",c.children[f]);this.getFirstClass(h)===d&&e.push(h)}return e},this.updateNodePrefix=function(a,b,c,d){var e=new RegExp("^"+c);b.a_attr.id=b.a_attr.id.replace(e,d);for(var f=b.li_attr["class"].split(" "),g=0,h=f.length;h>g;g++)f[g]=f[g].replace(e,d);b.li_attr["class"]=f.join(" ");for(var i=0,j=b.children.length;j>i;i++){var k=a.jstree("get_node",b.children[i]);this.updateNodePrefix(a,k,c,d)}a.jstree("_node_changed",b.id)},this.updateNodesPrefix=function(a,b,c){c=c||!1;for(var d=this.getNodeSiblingsAndSelf(b),e=this.getNodePositionInChildren(b,d),f=this.getFirstClass(b),g=0,h=d.length;h>g;g++)if(g>e||c&&g===e){var i=d[g],j=f+":[0-9]+:",k=f+":"+g+":";this.updateNodePrefix(a,i,j,k)}a.jstree("redraw")},this.addNode=function(b,c,d){var e=b.hasClass("btn-list"),f=(a(d.jstree_data),d.previous),g=this.findParentNodeAndPosition(f);if("undefined"==typeof g)return null;var h=c.jstree("create_node",g.parentobj,d.jstree_data,g.position),i=c.jstree("get_node",h);return e&&this.updateNodesPrefix(c,i),h},this.removeNode=function(a,b,c){var d,e=this.getTreeElementFromId(b),f=c.jstree("get_node",e);if(a.hasClass("btn-list")){var g=this.getNodeSiblingsAndSelf(f),h=this.getNodePositionInChildren(f,g);if(d=c.jstree("delete_node",e),h+1<g.length){var i=c.jstree("get_node",g[h+1]);this.updateNodesPrefix(c,i,!0)}}else d=c.jstree("delete_node",e);return d}}.call(xmltool.jstree.utils={},jQuery,xmltool),function(a,b){"use strict";var c=!1,d=function(a){return function(){return c?!1:(c=!0,a.apply(this,arguments),c=!1,void 0)}};this.load=function(c,e,f,g,h){var i=this;c.removeClass("jstree").empty(),c.jstree({plugins:["themes","ui","crrm","dnd","contextmenu"],core:{data:[e],html_titles:!0,check_callback:function(a,b,d,e,f){if("create_node"===a)return!0;if("delete_node"===a)return!0;if("move_node"===a){if(b.parent!==d.id)return!1;var g=d.children.length;if(1===g)return!1;if("i"===f.pos)return!1;var h=d.children.indexOf(b.id);if("b"===f.pos&&e-1===h)return!1;"a"===f.pos&&e>h&&(e+=1);var j,k;if(g>e&&(j=d.children[e],k=c.jstree("get_node",j),i.utils.getFirstClass(k)===i.utils.getFirstClass(b)))return!0;if(e>0&&(j=d.children[e-1],k=c.jstree("get_node",j),i.utils.getFirstClass(k)===i.utils.getFirstClass(b)))return!0}return!1}},contextmenu:{items:function(){return{copyItem:{label:"Copy",action:function(a){var d=c.jstree("get_node",a.reference);b.jstree.copy(d)}},pasteItem:{label:"Paste",action:function(a){var d=c.jstree("get_node",a.reference);b.jstree.paste(d)}}}}}}).bind("open_node.jstree",d(function(a,b){if(a.isDefaultPrevented())return!1;var c=i.utils.getCollapsibleElement(b.node);c.collapse("show"),a.preventDefault()})).bind("close_node.jstree",d(function(a,b){if(a.isDefaultPrevented())return!1;var c=i.utils.getCollapsibleElement(b.node);c.collapse("hide"),a.preventDefault()})).bind("select_node.jstree",d(function(a,c){var d=i.utils.getFormElement(c.node);b.utils.scrollToElement(d,g);var e=d.find("textarea:first");e.is(":visible")?e.focus():e.next().focus()})).bind("move_node.jstree",d(function(a,d){var e=i.utils.getFormElement(d.node),f=e.parent(".list-container"),g=e.prev(),h=i.utils.getNodeSiblingsAndSelf(d.node),j=i.utils.getNodePositionInChildren(d.node,h),k=i.utils.getFormPrefix(d.node);if(0===j)f.prepend(e),f.prepend(g);else{var l;l=d.position<d.old_position?0:1;var m=f.children().eq(2*(j+l)-1);m.after(e),m.after(g)}if(d.position>d.old_position){var n=d.position-d.old_position;j-=n;var o=c.jstree("get_node",h[j]);e=i.utils.getFormElement(o),g=e.prev()}b.form._updateElementsPrefix(g,j,k);var p=c.jstree("get_node",h[j]);i.utils.updateNodesPrefix(c,p,!0)})),f.on("focus","textarea.form-control",d(function(){var d=i.utils.getTreeElementFromTextarea(a(this));c.jstree("deselect_all").jstree("select_node",d),console.log("scroll to tree"),b.utils.scrollToElement(d,h)})).on("focus",".contenteditable",d(function(){var d=a(this).data("contenteditablesync").$target,e=i.utils.getTreeElementFromTextarea(d);c.jstree("deselect_all").jstree("select_node",e),b.utils.scrollToElement(e,h)})).on("blur","textarea",function(){var d=a(this),e=i.utils.getTreeElementFromTextarea(d),f=c.jstree("get_text",e),g=e.find("._tree_text");0===g.length&&(f+='<span class="_tree_text"></span>');var h;h=d.val()?" ("+b.utils.truncateText(d.val())+")":"",f=f.replace(/>[^<]*</,">"+h+"<"),c.jstree("set_text",e,f)}).on("shown.bs.collapse",".panel-collapse",d(function(b){if(b.isDefaultPrevented())return!1;var d=i.utils.getTreeElementFromCollapsible(a(this));c.jstree("open_node",d),b.preventDefault()})).on("hidden.bs.collapse",".panel-collapse",d(function(b){if(b.isDefaultPrevented())return!1;var d=i.utils.getTreeElementFromCollapsible(a(this));c.jstree("close_node",d),b.preventDefault()}))},this.copy=function(c){var d=b.jstree.utils.getFormId(c),e=b.jstree.utils.getFormElement(c),f=e.parents("form"),g=f.serialize(),h=f.data("copy-href"),i=f.data("xmltool");g+="&elt_id="+d,a.ajax({type:"POST",url:h,data:g,dataType:"json",async:!1,success:function(a){a.error_msg?i.message("error",a.error_msg):a.info_msg&&i.message("info",a.info_msg)},error:function(a){var b=a.status+" "+a.statusText;i.message("error",b)}})},this.paste=function(c){var d=b.jstree.utils.getFormId(c),e=b.jstree.utils.getFormElement(c),f=e.parents("form"),g=f.serialize(),h=f.data("paste-href"),i=f.data("xmltool");g+="&elt_id="+d,a.ajax({type:"POST",url:h,data:g,dataType:"json",async:!1,success:function(c){if(c.error_msg)return i.message("error",c.error_msg),!1;var d=b.utils.getAddButton(c.elt_id);b.form._addElement(c.elt_id,d,c.html),b.jstree.utils.addNode(d,a("#tree"),c),i.message("info","Pasted!")},error:function(a){var b=a.status+" "+a.statusText;i.message("error",b)}})}}.call(xmltool.jstree,jQuery,xmltool),"undefined"==typeof xmltool&&(xmltool={}),xmltool.utils={},function(a){"use strict";var b=30,c=["name","id","data-comment-name","data-target","data-elt-id","value"];this.escapeAttr=function(a){return a.replace(/([:\.])/g,"\\$1")},this.getElementById=function(b){return a("#"+this.escapeAttr(b))},this.scrollToElement=function(a,c){var d=a.offset().top+c.scrollTop()-c.offset().top-b;c.scrollTop(d)},this.updatePrefixAttrs=function(a,b,d){for(var e=new RegExp("^(#)?(collapse-)?"+b),f=0,g=c.length;g>f;f++){var h=c[f],i=a.attr(h);"undefined"!=typeof i&&(i=i.replace(e,"$1$2"+d),a.attr(h,i))}if("collapse"===a.attr("data-toggle")){e=new RegExp("^(#collapse-)"+this.escapeAttr(this.escapeAttr(b)));var j=a.attr("href");j=j.replace(e,"$1"+this.escapeAttr(d)),a.attr("href",j)}for(var k=a.children(),l=0,m=k.length;m>l;l++)this.updatePrefixAttrs(k.eq(l),b,d)},this.truncateText=function(a,b){b=b||30;var c,d;if(c=a.split(""),c.length>b){for(d=c.length-1;d>-1;--d)if(d>b)c.length=d;else if(" "===c[d]){c.length=d;break}c.push("...")}return c.join("")},this.cleanupContenteditableContent=function(a){return a=a.replace(/\r?\n?/g,""),a=a.replace(/<br ?\/?>/g,"\n"),a=a.replace(/\u00A0/g," ")},this.getPrefixIndexFromListEltId=function(a){var b=a.split(":"),c=b.length;return{index:parseInt(b[c-2],10),prefixId:b.slice(0,c-2).join(":")}},this.getAddButton=function(b){var c=a(".btn-add").find('[value="'+b+'"]');return c=1===c.length?c.parent("select"):a('[data-elt-id="'+b+'"]')}}.call(xmltool.utils,jQuery),"undefined"==typeof xmltool&&(xmltool={}),xmltool.form={},function(a){this._updateElementsPrefix=function(a,b,c){for(var d=a.nextAll().andSelf(),e=0,f=d.length;f>e;e++){var g=d.eq(e),h=c+":[0-9]+:",i=c+":"+b+":";xmltool.utils.updatePrefixAttrs(g,h,i),e%2!==0&&(b+=1)}},this._addElement=function(b,c,d){var e=a(d);if(c.hasClass("btn-list")){var f=xmltool.utils.getPrefixIndexFromListEltId(b),g=f.index;this._updateElementsPrefix(c,g+1,f.prefixId),c.before(e)}else c.replaceWith(e);c.is("select")&&c.val(c.find("option:first").val())},this.addElement=function(b,c,d,e,f,g,h){g="undefined"==typeof g?!0:g;var i;i=b.is("select")?b.val():b.attr("data-elt-id");var j=this,k={elt_id:i,dtd_url:d};if("undefined"!=typeof h)for(var l=0,m=h.length;m>l;l++){var n=h[l];k[n.name]=n.value}a.ajax({type:"GET",url:c,data:k,async:g,dataType:"json",success:function(h){if("undefined"!=typeof h.modal){var k=a(h.modal);k.find("form").on("submit",function(h){h.preventDefault(),k.modal("hide");var i=a(this).serializeArray();j.addElement(b,c,d,e,f,g,i)}),k.modal("show")}else j._addElement(i,b,h.html),xmltool.jstree.utils.addNode(b,f,h)},error:function(a){var b=a.status+" "+a.statusText;e("error"+b)}})},this.removeElement=function(b,c){var d=a(xmltool.utils.escapeAttr(b.data("target"))),e=d.attr("id");if(b.hasClass("btn-list")){var f=xmltool.utils.getPrefixIndexFromListEltId(d.attr("id")),g=f.index;this._updateElementsPrefix(d.next(),g,f.prefixId),d.prev(".btn-add").remove(),d.remove()}else{var h=b.prev(".btn-add").removeClass("hidden");d.replaceWith(h)}xmltool.jstree.utils.removeNode(b,e,c)}}.call(xmltool.form,jQuery),function(a){function b(c,d){this.options=a.extend({},b.DEFAULTS,d),this.$tree=null,this.init(c),this.message=this.options.message}b.prototype.init=function(b){var c=this;if(this.element=b,this.$form=a(b),this.dtdUrl=this.$form.find(this.options.dtdUrlSelector).val(),this.setEvents(),"undefined"!=typeof this.options.jstreeSelector){var d=a(this.options.jstreeSelector);d.length&&(this.$tree=d)}this.$form.on("click","a.btn-add",function(b){return b.preventDefault(),xmltool.form.addElement(a(this),c.options.add_element_url,c.dtdUrl,c.message,c.$tree),!1}).on("change","select.btn-add",function(b){return b.preventDefault(),xmltool.form.addElement(a(this),c.options.add_element_url,c.dtdUrl,c.message,c.$tree),!1}).on("mouseenter focus",".contenteditable",function(){var b=a(this);b.ckeditor({removePlugins:"toolbar"}),b.contenteditablesync({getContent:function(a){var b=a.ckeditorGet().getData();return xmltool.utils.cleanupContenteditableContent(b)}})}).on("click",".btn-delete",function(b){return b.preventDefault(),xmltool.form.removeElement(a(this),c.$tree),!1}).on("click",".btn-comment",function(b){b.preventDefault();var d=a(this),e=d.next("._comment");e.length||(e=a("<textarea>").attr("name",d.data("comment-name")).addClass("_comment").addClass("form-control"),d.after(e));var f=d.data("modal");return void 0===f&&a.ajax({type:"GET",url:c.options.comment_modal_url,data:{comment:e.val()},dataType:"json",async:!1,success:function(b){f=a(b.content),f.on("shown.bs.modal",function(){a(this).find("textarea").focus()}),d.data("modal",f),f.find(".submit").click(function(){var a=f.find("textarea").val();return e.val(a),f.modal("hide"),d.attr("title",a),a?d.addClass("has-comment"):d.removeClass("has-comment"),!1})},error:function(a){var b=a.status+" "+a.statusText;c.message("error",b)}}),f.modal("show"),!1}),"undefined"!=typeof this.options.jstreeData&&xmltool.jstree.load(this.$tree,this.options.jstreeData,this.$form,a(this.options.formContainerSelector),a(this.options.treeContainerSelector))},b.prototype.setEvents=function(){},b.DEFAULTS={open_dialog:function(a){a.modal("show")},close_dialog:function(a){a.modal("hide")},message:function(a,b){alert(a+": "+b)},treeContainerSelector:"#tree",formContainerSelector:"body",dtdUrlSelector:"#_xml_dtd_url"},a.fn.xmltool=function(c){return this.each(function(){var d=a(this),e=d.data("xmltool");e||(e=new b(this,c),d.data("xmltool",e))})}}(window.jQuery);